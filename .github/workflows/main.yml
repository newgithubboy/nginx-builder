name: Build Nginx for Ubuntu 22.04
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential wget ca-certificates
      - name: Download sources (with fallback mirrors)
        run: |
          # Nginx (官方HTTPS)
          wget https://nginx.org/download/nginx-1.24.0.tar.gz
          
          # PCRE2 (GitHub官方发布)
          wget https://github.com/PhilipHazel/pcre2/releases/download/pcre2-10.42/pcre2-10.42.tar.gz
          
          # zlib (关键修复：使用官方HTTPS + 备用镜像)
          if ! wget https://zlib.net/zlib-1.2.13.tar.gz; then
            echo "⚠️ Primary mirror failed, trying GitHub backup..."
            wget https://github.com/madler/zlib/releases/download/v1.2.13/zlib-1.2.13.tar.gz
          fi
          
          # OpenSSL (官方HTTPS)
          wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz
          
          # 验证所有文件
          for f in *.tar.gz; do
            echo "✅ Downloaded: $f"
            tar -xzf "$f"
          done
      - name: Compile Nginx
        run: |
          cd nginx-1.24.0
          ./configure \
            --with-pcre=../pcre2-10.42 \
            --with-zlib=../zlib-1.2.13 \
            --with-openssl=../openssl-1.1.1w \
            --with-http_ssl_module \
            --with-http_v2_module \
            --prefix=/opt/nginx
          make -j$(nproc)
          make install
      - name: Package artifact
        run: tar czf nginx-offline.tar.gz -C /tmp nginx
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-ubuntu2204-package
          path: nginx-offline.tar.gz
